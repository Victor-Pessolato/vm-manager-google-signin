<!doctype html>
<html>

<head>
	<title>GCE Instances Manager</title>
	<meta name="google-signin-client_id" content="{{ gsignin_key }}">

	<script src="https://apis.google.com/js/platform.js" async defer></script>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	<link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
		integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
	<style>
		.spinner-border-lg {
			width: 4rem;
			height: 4rem;
		}

		.pos-rel {
			position: relative;
		}

		.btn-action {
			position: absolute;
			top: 1em;
			right: 1em;
		}
	</style>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
		<a class="navbar-brand" href="javascript:void(0)">GCE Instances Manager</a>
		<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navb">
            <span class="navbar-toggler-icon"></span>
        </button>

		<div class="collapse navbar-collapse" id="navb">
			<div class="mr-auto"></div>
			<div id="nav_user_info">
				<div id="gsignin_btn" class="g-signin2" data-onsuccess="onSignIn"></div>
			</div>
		</div>
	</nav>

	<main class="container-fluid">
		<div class="row">
			<div id="main-workspace" class="col-12 d-flex justify-content-center align-items-center flex-wrap"
				style="min-height: 90vh">
				<div class="text-center">
					<h2>Hello!</h2>
					<h4>You will be able to see the information once you signin with your account.</h4>
					<h4>If you already signed in, wait a moment so we can check who you are..</h4>
				</div>
			</div>
		</div>
	</main>

    <div class="modal fade" id="confirm_modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div id="confirm_text" class="modal-body"></div>

                <div id="confirm_actions" class="modal-footer"></div>
            </div>
        </div>
    </div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="{{ url_for('static', filename='script.js') }}"></script>
	<script>
	
    function openModal(action) {
        let confirmText = `Are you sure you wish to ${action} this GCE instance?`;
        let confirmActions = `<button class="btn btn-light btn-sm" data-dismiss="modal">CANCEL</button><button class="btn btn-info btn-sm font-weight-bold" onclick="requestAction(this)">${action.toUpperCase()}</button>`;
        $("#confirm_text").html(confirmText);
        $("#confirm_actions").html(confirmActions);
        $("#confirm_modal").modal('show');
    }

    function requestAction(caller) {
        if ($(caller).hasClass('disabled') == false) {
            let action = $(caller).text().toLowerCase();
            // TODO: Make the request to update the status of the VM
        }
        addSpinnerToButton(caller);
    }

    function addSpinnerToButton(target) {
        $_target = $(target);
        $_spinner = $_target.children(".spinner-border");
        if ($_spinner.length <= 0) {
            $_target.append(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`);
        } else {
            $_spinner.show();
        }
        $_target.addClass('disabled');
    }

    function getInstances(id_token) {
        $_workspace = $("#main-workspace");
        $_workspace.html(`<div id="workspace-spinner" class="spinner-border spinner-border-lg"></div>`);
        $.ajax({
            url: '/zones',
            headers: { 'x-user-token': id_token }
        }).done(function(data) {
            if(data.zone_count > 0) {
                function getInstanceByZone() {
                    let zone = data.zones.pop();
                    if(zone) {
                        $.ajax({
                            url: '/instances/' + zone.name,
                            headers: { 'x-user-token': id_token }
                        }).done(function(data) {
                            // Display data
                            if(!data.message) {
                                $_workspace.prepend(data);
                            }                            
                            // Continue handling the queue 
                            getInstanceByZone();  
                        });
                    } else {
                        $("#workspace-spinner").fadeOut();
                    }
                }

                getInstanceByZone();

            } else {
                $_workspace.html(`<h2 class="text-center">An error occured when trying to fetch GPC zones</h2>`);
            }

        });
    }

    function getUserData(id_token) {
        $.ajax({
            url: '/get-user-data',
            headers: { 'x-user-token': id_token }
        }).done(function(data) {
            $("#nav_user_info").html(data);
        });
    }

	// Checks if the user logged in is valid.
    function loadApp(id_token) {
        // Load user data
        getUserData(id_token);

        // Load instances data
        getInstances(id_token);
    }

    // Callback for when the user sign in from the web and when we do the first check.
    function onSignIn(googleUser) {
        let id_token = googleUser.getAuthResponse().id_token;
        loadApp(id_token);
    }

    // Sign out function from The Google Signin API
    function signOut() {
        let auth2 = gapi.auth2.getAuthInstance();
        let googleUser = auth2.currentUser.get();

        $.ajax({
            url: '/sign-out',
            headers: { 'x-user-token': googleUser.getAuthResponse().id_token }
        }).done(function(data) {
            auth2.signOut().then(function () {
                console.log('User signed out.');
                location.reload();
            });
        });
    }

    // If user is already logged in the browser we check if it's a valid user and if it is registered in our DB
    if (auth2.isSignedIn.get()) {
        onSignIn(googleUser);
    }

	</script>
</body>

</html>